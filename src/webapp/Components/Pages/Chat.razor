@page "/chat"
@rendermode InteractiveServer
@using Microsoft.Extensions.AI
@using webapp.Models
@inject IConfiguration Config

<PageTitle>AI Chat</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    
    @* Error notification *@
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4" CloseIconClicked="@(() => errorMessage = null)" ShowCloseIcon="true">
            @errorMessage
        </MudAlert>
    }
    
    @* Chat history container *@
    <MudPaper Class="pa-4 mb-4" Style="height: 500px; overflow-y: auto;" id="chatContainer">
        @foreach (var message in chatHistory)
        {
            var bubbleClass = message.Role == "user" ? "user-bubble" : "ai-bubble";
            var containerClass = message.Role == "user" ? "d-flex justify-end mb-3" : "d-flex justify-start mb-3";
            
            <div class="@containerClass">
                <MudPaper Elevation="2" Class="@($"pa-3 {bubbleClass}")">
                    <MudText Typo="Typo.body1">@message.Content</MudText>
                    <MudText Typo="Typo.caption" Class="mt-1" Style="opacity: 0.7;">
                        @message.Timestamp.ToString("HH:mm")
                    </MudText>
                </MudPaper>
            </div>
        }
        
        @if (isLoading)
        {
            <div class="d-flex justify-start mb-3">
                <MudPaper Elevation="2" Class="pa-3 ai-bubble">
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                </MudPaper>
            </div>
        }
    </MudPaper>
    
    @* Input area *@
    <div class="d-flex gap-2">
        <MudTextField @bind-Value="currentMessage" 
                      Label="Type your message" 
                      Variant="Variant.Outlined"
                      FullWidth="true"
                      Disabled="@isLoading"
                      Lines="2" />
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   OnClick="SendMessage"
                   Disabled="@(isLoading || string.IsNullOrWhiteSpace(currentMessage))"
                   Style="height: fit-content;">
            <MudIcon Icon="@Icons.Material.Filled.Send" />
        </MudButton>
    </div>
    
</MudContainer>

<style>
    .user-bubble {
        max-width: 70%;
        background-color: var(--mud-palette-primary);
        color: white;
    }
    .ai-bubble {
        max-width: 70%;
        background-color: var(--mud-palette-surface);
    }
</style>

@code {
    private List<Models.ChatMessage> chatHistory = new();
    private List<Microsoft.Extensions.AI.ChatMessage> messages = new();
    private string currentMessage = "";
    private string? errorMessage;
    private bool isLoading = false;
    private IChatClient? chatClient;
    
    protected override void OnInitialized()
    {
        try
        {
            // Verify that IConfiguration is available
            if (Config == null)
            {
                errorMessage = "Configuration service is not available.";
                return;
            }
            
            var apiKey = Config["REKA_API_KEY"];
            if (string.IsNullOrEmpty(apiKey))
            {
                errorMessage = "REKA_API_KEY is not configured. Please set it in your environment variables or configuration.";
                return;
            }
            
            // Initialize OpenAI client using Microsoft.Extensions.AI pattern
            var openaiClient = new OpenAI.OpenAIClient(new System.ClientModel.ApiKeyCredential(apiKey), new OpenAI.OpenAIClientOptions
            {
                Endpoint = new Uri("https://api.reka.ai/v1")
            });
            chatClient = openaiClient.AsChatClient("reka-core");
        }
        catch (Exception ex)
        {
            errorMessage = $"Initialization error: {ex.Message}";
        }
    }
    
    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(currentMessage) || chatClient == null) return;
        
        var userMsg = currentMessage.Trim();
        
        // Add user message to display history
        chatHistory.Add(new Models.ChatMessage 
        { 
            Role = "user", 
            Content = userMsg,
            Timestamp = DateTime.Now
        });
        
        // Add user message to the messages list
        messages.Add(new Microsoft.Extensions.AI.ChatMessage(ChatRole.User, userMsg));
        
        currentMessage = "";
        isLoading = true;
        
        try
        {
            // Send messages using the Microsoft.Extensions.AI pattern
            var response = await chatClient.CompleteAsync(messages);
            
            var assistantMessage = response.Message.Text ?? "No response";
            
            // Add assistant message to both lists
            messages.Add(new Microsoft.Extensions.AI.ChatMessage(ChatRole.Assistant, assistantMessage));
            chatHistory.Add(new Models.ChatMessage 
            { 
                Role = "assistant", 
                Content = assistantMessage,
                Timestamp = DateTime.Now
            });
            
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
        
        StateHasChanged();
    }
}
